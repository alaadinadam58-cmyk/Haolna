<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Jamba Chat</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{font-family:Arial;direction:rtl;text-align:center;}
#chat{height:300px;overflow-y:auto;border:1px solid #ccc;margin:10px;padding:10px;}
input,button{padding:10px;margin:5px;}
.my{color:blue;}
.other{color:green;}
</style>
</head>
<body>

<h2>دردشة جامبا</h2>

<input id="username" placeholder="اكتب اسمك"/>
<button onclick="saveUsername()">حفظ الاسم</button>

<div id="chat"></div>

<input id="message" placeholder="اكتب رسالة..."/>
<button onclick="sendMessage()">إرسال</button>

<script>
const supabase = window.supabase.createClient(
  "szjeerdjuyuqyrixqihb",
  "sb_publishable_GpdhY2DBLlI0t3VdzXUWOA_dt43iBLx"
);
async function requestNotificationPermission() {
  if (Notification.permission !== "granted") {
    await Notification.requestPermission();
  }
}
requestNotificationPermission();

let currentUserId = localStorage.getItem("user_id");

// حفظ الاسم
async function saveUsername(){
  const username = document.getElementById("username").value;
  if(!username) return;

  const { data, error } = await supabase.from("users").insert({username}).select().single();
  if(!error){
    currentUserId = data.id;
    localStorage.setItem("user_id", currentUserId);
    loadMessages();
  }
}
<audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/notification_simple.ogg"></audio>

// إرسال الرسائل
async function sendMessage(){
  const content = document.getElementById("message").value;
  if(!content || !currentUserId) return;

  await supabase.from("messages").insert({content, sender_id: currentUserId});
  document.getElementById("message").value = "";
}

// تحميل الرسائل وعرض الاسم الحقيقي
async function loadMessages(){
  const { data, error } = await supabase
    .from("messages")
    .select("content, sender_id, users:sender_id (username)")
    .order("created_at",{ascending:true});

  if(error){ console.log(error); return; }

  const chat = document.getElementById("chat");
  chat.innerHTML = "";

  data.forEach(msg=>{
    const div = document.createElement("div");
    const name = msg.users?.username || "مستخدم";
    div.textContent = name + ": " + msg.content;
    div.className = msg.sender_id === currentUserId ? "my" : "other";
    chat.appendChild(div);
  });

  chat.scrollTop = chat.scrollHeight;
}

if (payload.new.sender_id !== currentUserId) {
  document.getElementById("notifSound").play();

  if (Notification.permission === "granted") {
    new Notification("رسالة جديدة", {
      body: "عندك رسالة جديدة في الدردشة",
    });
  }
}


      // تشغيل صوت الإشعار لو الرسالة من شخص تاني
      if (payload.new.sender_id !== currentUserId) {
        document.getElementById("notifSound").play();
      }
    }
  )
  .subscribe();

</script>
</body>
</html>


