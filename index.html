<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

document.addEventListener("DOMContentLoaded", async () => {

const supabase = createClient(
  "https://szjeerdjuyuqyrixqihb.supabase.co",
  "sb_publishable_GpdhY2DBLlI0t3VdzXUWOA_dt43iBLx"
);

let me = null;
let currentChatId = null;

/* ========================= */
/* تحميل المستخدم المحفوظ */
/* ========================= */

const savedId = localStorage.getItem("user_id");
if (savedId) {
  const { data } = await supabase
    .from("users")
    .select("*")
    .eq("id", savedId)
    .single();

  if (data) {
    me = data;
    document.getElementById("username-area").style.display = "none";
    loadUsers();
  }
}

/* ========================= */
/* حفظ الاسم */
/* ========================= */

document.getElementById("saveName").addEventListener("click", async () => {
  const username = document.getElementById("username").value.trim();
  if (!username) return;

  const { data, error } = await supabase
    .from("users")
    .insert({ username })
    .select()
    .single();

  if (error) return alert(error.message);

  me = data;
  localStorage.setItem("user_id", me.id);
  document.getElementById("username-area").style.display = "none";
  loadUsers();
});

/* ========================= */
/* تحميل المستخدمين */
/* ========================= */

async function loadUsers() {
  const { data } = await supabase
    .from("users")
    .select("*")
    .neq("id", me.id);

  const list = document.getElementById("user-list");
  list.innerHTML = "";

  data.forEach(user => {
    const btn = document.createElement("button");
    btn.textContent = user.username;
    btn.onclick = () => startChat(user);
    list.appendChild(btn);
  });
}

/* ========================= */
/* بدء محادثة */
/* ========================= */

async function startChat(user) {
  document.getElementById("chat-header").textContent =
    "محادثة مع " + user.username;

  document.getElementById("chat-input-area").style.display = "flex";

  const { data: chats } = await supabase
    .from("chats")
    .select("*")
    .or(`and(user1.eq.${me.id},user2.eq.${user.id}),and(user1.eq.${user.id},user2.eq.${me.id})`)
    .limit(1);

  if (chats.length > 0) {
    currentChatId = chats[0].id;
  } else {
    const { data: newChat } = await supabase
      .from("chats")
      .insert({ user1: me.id, user2: user.id })
      .select()
      .single();

    currentChatId = newChat.id;
  }

  loadMessages();
}

/* ========================= */
/* تحميل الرسائل */
/* ========================= */

async function loadMessages() {
  if (!currentChatId) return;

  const { data } = await supabase
    .from("messages")
    .select("*")
    .eq("chat_id", currentChatId)
    .order("created_at", { ascending: true });

  const box = document.getElementById("messages");
  box.innerHTML = "";

  data.forEach(msg => {
    const div = document.createElement("div");
    div.className = msg.sender_id === me.id ? "my" : "other";
    div.textContent = msg.text;
    box.appendChild(div);
  });

  box.scrollTop = box.scrollHeight;
}

/* ========================= */
/* إرسال رسالة */
/* ========================= */

document.getElementById("send").addEventListener("click", async () => {
  const input = document.getElementById("msg");
  const text = input.value.trim();
  if (!text || !currentChatId) return;

  await supabase.from("messages").insert({
    chat_id: currentChatId,
    sender_id: me.id,
    text: text
  });

  input.value = "";
  loadMessages();
});

/* ========================= */
/* التحديث اللحظي */
/* ========================= */

supabase.channel("realtime")
  .on(
    "postgres_changes",
    { event: "INSERT", schema: "public", table: "messages" },
    payload => {
      if (payload.new.chat_id === currentChatId) {
        loadMessages();
      }
    }
  )
  .subscribe();

});
</script>


/* ========================= */
/* إرسال رسالة */
/* ========================= */

document.getElementById("send").onclick = async () => {
  const input = document.getElementById("msg");
  const text = input.value.trim();
  if (!text || !currentChatId) return;

  await supabase.from("messages").insert({
    chat_id: currentChatId,
    sender_id: me.id,
    text: text
  });

  input.value = "";
  loadMessages();
};

/* ========================= */
/* التحديث اللحظي */
/* ========================= */

supabase.channel("realtime")
  .on("postgres_changes",
    { event: "INSERT", schema: "public", table: "messages" },
    payload => {
      if (payload.new.chat_id === currentChatId) {
        loadMessages();
      }
    })
  .subscribe();

</script>


