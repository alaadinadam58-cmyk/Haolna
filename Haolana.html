<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Jamba Chat</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;direction:rtl;text-align:center;}
#chat{height:300px;overflow-y:auto;border:1px solid #ccc;margin:10px;padding:10px;}
input,button{padding:10px;margin:5px;}
.my{color:blue;}
.other{color:green;}
</style>
</head>
<body>

<h2>دردشة جامبا</h2>

<input id="username" placeholder="اكتب اسمك"/>
<button onclick="saveUsername()">حفظ الاسم</button>

<div id="chat"></div>

<input id="message" placeholder="اكتب رسالة..."/>
<button onclick="sendMessage()">إرسال</button>

<!-- صوت الإشعار -->
<audio id="notifSound">
  <source src="https://actions.google.com/sounds/v1/alarms/notification_simple.ogg" type="audio/ogg">
</audio>

<script>
const supabase = window.supabase.createClient(
  "https://szjeerdjuyuqyrixqihb.supabase.co",
  "sb_publishable_GpdhY2DBLlI0t3VdzXUWOA_dt43iBLx"
);

let currentUserId = localStorage.getItem("user_id");


// ===== طلب إذن الإشعارات =====
async function requestNotificationPermission(){
  if ("Notification" in window) {
    if (Notification.permission !== "granted") {
      await Notification.requestPermission();
    }
  }
}
requestNotificationPermission();


// ===== حفظ الاسم =====
async function saveUsername(){
  const username = document.getElementById("username").value;
  if(!username) return;

  const { data, error } = await supabase
    .from("users")
    .insert({username})
    .select()
    .single();

  if(!error){
    currentUserId = data.id;
    localStorage.setItem("user_id", currentUserId);
    loadMessages();
  }else{
    alert("خطأ في حفظ الاسم");
    console.log(error);
  }
}


// ===== إرسال رسالة =====
async function sendMessage(){
  const content = document.getElementById("message").value;
  if(!content || !currentUserId) return;

  const { error } = await supabase
    .from("messages")
    .insert({content, sender_id: currentUserId});

  if(error){
    alert("فشل إرسال الرسالة");
    console.log(error);
  }

  document.getElementById("message").value = "";
}


// ===== تحميل الرسائل =====
async function loadMessages(){
  const { data, error } = await supabase
    .from("messages")
    .select("content, sender_id, users:sender_id (username)")
    .order("created_at",{ascending:true});

  if(error){
    console.log(error);
    return;
  }

  const chat = document.getElementById("chat");
  chat.innerHTML = "";

  data.forEach(msg=>{
    const div = document.createElement("div");
    const name = msg.users?.username || "مستخدم";
    div.textContent = name + ": " + msg.content;
    div.className = msg.sender_id === currentUserId ? "my" : "other";
    chat.appendChild(div);
  });

  chat.scrollTop = chat.scrollHeight;
}


// ===== التحديث اللحظي + الإشعارات =====
supabase
.channel("realtime-messages")
.on(
  "postgres_changes",
  { event:"INSERT", schema:"public", table:"messages" },
  (payload)=>{

    loadMessages();

    // لو الرسالة من شخص آخر
    if(payload.new.sender_id !== currentUserId){

      // تشغيل الصوت
      const audio = document.getElementById("notifSound");
      audio.play().catch(()=>{});

      // إشعار مرئي
      if(Notification.permission === "granted"){
        new Notification("رسالة جديدة",{
          body:"عندك رسالة جديدة في الدردشة"
        });
      }
    }
  }
)
.subscribe();


// تحميل أولي
loadMessages();
</script>

</body>
</html>

