<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>دردشة حولنا</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h2 {
      color: #1a73e8;
      margin-bottom: 10px;
    }

    /* صندوق الدردشة */
    #chat {
      width: 100%;
      max-width: 500px;
      height: 400px;
      overflow-y: auto;
      border-radius: 10px;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message {
      padding: 8px 12px;
      border-radius: 8px;
      background: #e1f5fe;
      width: fit-content;
      max-width: 80%;
    }

    .input-area {
      display: flex;
      gap: 10px;
      width: 100%;
      max-width: 500px;
    }

    input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      padding: 10px 20px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover { background: #1557b0; }
  </style>
</head>
<body>

  <h2>دردشة حولنا</h2>

  <div id="chat">
    </div>

  <div class="input-area">
    <input type="text" id="messageInput" placeholder="اكتب رسالتك..." />
    <button onclick="sendMessage()">إرسال</button>
  </div>

  <script>
    // بيانات الربط مع Supabase (استبدل هذه بالبيانات الخاصة بمشروعك)
    const SUPABASE_URL = 'https://szjeerdjuyuqyrixqihb.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_GpdhY2DBLlI0t3VdzXUWOA_dt43iBLx';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const chatDiv = document.getElementById('chat');
    const input = document.getElementById('messageInput');

    // دالة لجلب الرسائل القديمة
    async function fetchMessages() {
      const { data, error } = await supabase
        .from('messages') // تأكد أن اسم الجدول 'messages'
        .select('*')
        .order('created_at', { ascending: true });

      if (data) {
        chatDiv.innerHTML = '';
        data.forEach(msg => displayMessage(msg.text));
      }
    }

    // دالة لإرسال رسالة
    async function sendMessage() {
      const text = input.value;
      if (!text) return;

      const { error } = await supabase
        .from('messages')
        .insert([{ text: text }]);

      if (!error) input.value = '';
    }

    // دالة لعرض الرسالة في الواجهة
    function displayMessage(text) {
      const div = document.createElement('div');
      div.className = 'message';
      div.textContent = text;
      chatDiv.appendChild(div);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    // الاشتراك في التغييرات اللحظية (Real-time)
    supabase
      .channel('public:messages')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
        displayMessage(payload.new.text);
      })
      .subscribe();

    // جلب الرسائل عند فتح الصفحة
    fetchMessages();
  </script>
</body>
</html>
