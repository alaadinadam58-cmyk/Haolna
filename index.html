<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title> حولنا</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin:0;
  padding:0;
  background:#f2f4f7;
  display:flex;
  flex-direction:column;
  height:100vh;
}

/* الهيدر */
header {
  width:100%;
  background:#1a73e8;
  color:white;
  padding:15px;
  font-size:20px;
  text-align:center;
}

/* المستخدمين في الأعلى */
#user-list {
  width:100%;
  background:white;
  padding:10px;
  display:flex;
  gap:10px;
  overflow-x:auto;
  border-bottom:1px solid #ddd;
}

#user-list h3 {
  margin:0 10px;
  display:flex;
  align-items:center;
}

#user-list button {
  padding:8px 15px;
  border:none;
  border-radius:20px;
  cursor:pointer;
  background:#e4e6eb;
  white-space:nowrap;
}

#user-list button:hover {
  background:#cfd3d8;
}

/* لوحة الدردشة */
.chat-panel {
  flex:1;
  display:flex;
  flex-direction:column;
  padding:15px;
}

/* عنوان الدردشة */
#chat-header {
  font-size:18px;
  margin-bottom:10px;
}

/* الرسائل */
#messages {
  flex:1;
  overflow-y:auto;
  background:white;
  border-radius:10px;
  padding:15px;
  display:flex;
  flex-direction:column;
  gap:5px;
  font-size:16px;
}

/* شكل الرسائل */
.my {
  background:#0084ff;
  color:white;
  padding:8px 14px;
  border-radius:18px;
  align-self:flex-end;
  max-width:70%;
}

.other {
  background:#4caf50;
  color:white;
  padding:8px 14px;
  border-radius:18px;
  align-self:flex-start;
  max-width:70%;
}

/* منطقة الإدخال */
.input-area {
  display:flex;
  padding:10px;
  background:white;
  border-top:1px solid #ddd;
}

#msg {
  flex:1;
  padding:12px;
  border-radius:25px;
  border:1px solid #ccc;
  font-size:15px;
}

#send {
  margin-left:10px;
  padding:10px 20px;
  border:none;
  border-radius:25px;
  background:#1a73e8;
  color:white;
  cursor:pointer;
}

#send:hover {
  background:#1557b0;
}
  /* إشعار مرئي */
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #1a73e8;
  color: white;
  padding: 12px 18px;
  border-radius: 8px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  font-size: 14px;
  opacity: 0;
  transform: translateY(-20px);
  transition: all 0.3s ease;
  z-index: 9999;
}

.toast.show {
  opacity: 1;
  transform: translateY(0);
}
.unread-badge {
  color: red;
  font-weight: bold;
}

</style>
</head>

<body>

<header>دردشة حولنا</header>

<!-- المستخدمين بالأعلى -->
<div id="user-list"></div>

<!-- الدردشة بالأسفل أكبر -->
<div class="chat-panel">
  <h3 id="chat-header">اختر مستخدم لبدء المحادثة</h3>
  <div id="messages"></div>
  <div class="input-area">
    <input id="msg" placeholder="اكتب رسالة..." />
    <button id="send">إرسال</button>
  </div>
</div>

<script type="module">
  let unreadCounts = {};

/* نفس كودك بدون أي تغيير */
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://szjeerdjuyuqyrixqihb.supabase.co",
  "sb_publishable_GpdhY2DBLlI0t3VdzXUWOA_dt43iBLx"
);

let me = null;
let chatId = null;
let channel = null;

async function initUser() {
  let saved = localStorage.getItem("uid");
  if (saved) {
    let { data } = await supabase.from("users").select("*").eq("id", saved).single();
    if (data) { me = data; return; }
  }

  let name = prompt("اكتب اسمك");
  if (!name) return;

  let { data } = await supabase.from("users")
    .insert({ username: name })
    .select()
    .single();

  localStorage.setItem("uid", data.id);
  me = data;
}

async function loadUsers() {
  let { data } = await supabase
    .from("users")
    .select("*")
    .neq("id", me.id);

  let box = document.getElementById("user-list");
  box.innerHTML = "";

  data.forEach(u => {
    let b = document.createElement("button");
    b.id = "user-" + u.id;

    let count = unreadCounts[u.id] || 0;

    if (count > 0) {
      b.innerHTML = `
        ${u.username} 
        <span class="unread-badge">(${count})</span>
      `;
    } else {
      b.textContent = u.username;
    }

    b.onclick = () => {
      unreadCounts[u.id] = 0;
      openChat(u);
      loadUsers();
    };

    box.appendChild(b);
  });

}



async function openChat(u) {

  let { data } = await supabase
    .from("chats")
    .select("*")
    .or(`and(user1.eq.${me.id},user2.eq.${u.id}),and(user1.eq.${u.id},user2.eq.${me.id})`)
    .single();

  if (!data) {
    let res = await supabase.from("chats")
      .insert({ user1: me.id, user2: u.id })
      .select()
      .single();
    data = res.data;
  }

  chatId = data.id;

  document.getElementById("chat-header").textContent = "الدردشة مع " + u.username;

  await loadMessages();
 
}

async function loadMessages() {

  let { data, error } = await supabase
    .from("messages")
    .select(`
      text,
      sender_id,
      sender:sender_id ( username )
    `)
    .eq("chat_id", chatId)
    .order("created_at", { ascending: true });

  if (error) {
    console.error(error);
    return;
  }

  let box = document.getElementById("messages");
  box.innerHTML = "";

  data.forEach(msg => {

    let div = document.createElement("div");

    let senderName = msg.sender?.username || "مستخدم";

    div.textContent = senderName + ": " + msg.text;

    div.className =
      msg.sender_id === me.id ? "my" : "other";

    box.appendChild(div);
  });


}

  box.scrollTop = box.scrollHeight;
}
function showToast(message) {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.textContent = message;

  document.body.appendChild(toast);

  setTimeout(() => {
    toast.classList.add("show");
  }, 100);

  setTimeout(() => {
    toast.classList.remove("show");
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function listenMessages() {

  if (channel) {
    supabase.removeChannel(channel);
    channel = null;
  }

  channel = supabase
    .channel("my-incoming-messages")
    .on(
      "postgres_changes",
      {
        event: "INSERT",
        schema: "public",
        table: "messages",
        filter: `receiver_id=eq.${me.id}`
      },
      async (payload) => {

        const msg = payload.new;

        // إذا الرسالة ليست في الشات المفتوح → عداد
        if (msg.chat_id !== chatId) {

          unreadCounts[msg.sender_id] =
            (unreadCounts[msg.sender_id] || 0) + 1;

          loadUsers();
          return;
        }

        // عرض مباشر
        const { data } = await supabase
          .from("users")
          .select("username")
          .eq("id", msg.sender_id)
          .single();

        let box = document.getElementById("messages");

        let div = document.createElement("div");
        div.textContent = (data?.username || "مستخدم") + ": " + msg.text;
        div.className = "other";

        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
      }
    )
    .subscribe();
}




document.getElementById("send").onclick = async () => {
  let t = document.getElementById("msg").value;
  if (!t || !chatId) return;

  // معرفة المستخدم الآخر في الشات
  const { data: chat } = await supabase
    .from("chats")
    .select("user1, user2")
    .eq("id", chatId)
    .single();

  let receiverId =
    chat.user1 === me.id ? chat.user2 : chat.user1;

  await supabase.from("messages").insert({
    chat_id: chatId,
    sender_id: me.id,
    receiver_id: receiverId,
    text: t
  });

  document.getElementById("msg").value = "";
};

  

await initUser();
await loadUsers();
listenMessages();

</script>
</body>
</html>


















