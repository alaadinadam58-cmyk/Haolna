<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jamba Chat</title>

<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f2f4f7; display:flex; flex-direction:column; align-items:center; }
header { width:100%; background:#1a73e8; color:white; padding:15px 20px; font-size:20px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.2); }
.container { display:flex; max-width:900px; width:100%; margin-top:20px; gap:20px; }
#user-list { width:30%; background:white; border-radius:10px; padding:15px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
#user-list button { display:block; width:100%; margin:8px 0; padding:10px; border:none; border-radius:8px; cursor:pointer; background:#e4e6eb; transition:0.3s; }
#user-list button:hover { background:#cfd3d8; }
.chat-panel { flex:1; display:flex; flex-direction:column; background:white; border-radius:10px; padding:15px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
#chat-header { font-size:16px; margin-bottom:10px; color:#333; }
#messages { flex:1; overflow-y:auto; border:1px solid #ccc; padding:10px; background:#fafafa; border-radius:8px; margin-bottom:10px; }
.my { color:white; background:#0084ff; padding:6px 12px; border-radius:15px; display:inline-block; margin:4px 0; align-self:flex-end; max-width:80%; word-wrap: break-word; }
.other { color:white; background:#4caf50; padding:6px 12px; border-radius:15px; display:inline-block; margin:4px 0; align-self:flex-start; max-width:80%; word-wrap: break-word; }
.input-area { display:flex; gap:10px; }
input { flex:1; padding:10px; border-radius:20px; border:1px solid #ccc; outline:none; }
button#send { padding:10px 20px; border:none; border-radius:20px; background:#1a73e8; color:white; cursor:pointer; transition:0.3s; }
button#send:hover { background:#1557b0; }
.sender-name { font-size:10px; font-weight:bold; display:block; margin-bottom:2px; opacity:0.8; }
</style>
</head>
<body>

<header>دردشة جامبا</header>
<div class="container">
  <div id="user-list"></div>
  <div class="chat-panel">
    <h3 id="chat-header">اختر مستخدم لبدء المحادثة</h3>
    <div id="messages"></div>
    <div class="input-area">
</div>
  </div>
</div>
<input id="msg" placeholder="اكتب رسالة..." />
<button id="send">إرسال</button>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* ضع بيانات مشروعك هنا فقط */
const supabase = createClient(
  "https://szjeerdjuyuqyrixqihb.supabase.co",
  "sb_publishable_GpdhY2DBLlI0t3VdzXUWOA_dt43iBLx"
);

let me = null;
let chatId = null;
let channel = null;

/* إنشاء أو جلب المستخدم */
async function initUser() {
  let saved = localStorage.getItem("uid");

  if (saved) {
    let { data } = await supabase.from("users").select("*").eq("id", saved).single();
    if (data) { me = data; return; }
  }

  let name = prompt("اكتب اسمك");
  if (!name) return;

  let { data } = await supabase.from("users")
    .insert({ username: name })
    .select()
    .single();

  localStorage.setItem("uid", data.id);
  me = data;
}

/* تحميل المستخدمين */
async function loadUsers() {
  let { data } = await supabase
    .from("users")
    .select("*")
    .neq("id", me.id);

  let box = document.getElementById("user-list");
  box.innerHTML = "<h3>المستخدمين:</h3>";

  data.forEach(u => {
    let b = document.createElement("button");
    b.textContent = u.username;
    b.onclick = () => openChat(u);
    box.appendChild(b);
  });
}

/* فتح محادثة بين شخصين */
async function openChat(u) {

  let { data } = await supabase
    .from("chats")
    .select("*")
    .or(`and(user1.eq.${me.id},user2.eq.${u.id}),and(user1.eq.${u.id},user2.eq.${me.id})`)
    .single();

  if (!data) {
    let res = await supabase.from("chats")
      .insert({ user1: me.id, user2: u.id })
      .select()
      .single();
    data = res.data;
  }

  chatId = data.id;

  document.getElementById("chat-header").textContent = "الدردشة مع " + u.username;

  await loadMessages();
  listenMessages();
}

/* تحميل الرسائل القديمة */
async function loadMessages() {
  let { data, error } = await supabase
    .from("messages")
    .select("text, sender_id, users(username)")
    .eq("chat_id", chatId)
    .order("created_at", { ascending: true });

  if (error) {
    console.error(error);
    return;
  }

  let box = document.getElementById("messages");
  box.innerHTML = "";

  data.forEach(msg => {
    let div = document.createElement("div");

    let senderName = msg.users?.username || "مستخدم";

    div.textContent = senderName + ": " + msg.text;
    div.className = msg.sender_id === me.id ? "my" : "other";

    box.appendChild(div);
  });

  box.scrollTop = box.scrollHeight;
}


/* الاستماع اللحظي */
function listenMessages() {

  if (channel) supabase.removeChannel(channel);

  channel = supabase
    .channel("room-" + chatId)
    .on(
      "postgres_changes",
      {
        event: "INSERT",
        schema: "public",
        table: "messages",
        filter: `chat_id=eq.${chatId}`
      },
      payload => addMsg(payload.new)
    )
    .subscribe();
}

/* عرض رسالة في الشاشة */
function addMsg(msg) {
  let div = document.createElement("div");

  let senderName = msg.username || "مستخدم";

  div.textContent = senderName + ": " + msg.text;

  div.className = msg.sender_id === me.id ? "my" : "other";

  document.getElementById("messages").appendChild(div);
}

/* إرسال رسالة */
document.getElementById("send").onclick = async () => {
  let t = document.getElementById("msg").value;
  if (!t || !chatId) return;

  await supabase.from("messages").insert({
    chat_id: chatId,
    sender_id: me.id,
    text: t
  });

  document.getElementById("msg").value = "";

  /* إظهار فوري */
  await loadMessages();
};

/* بدء التشغيل */
await initUser();
await loadUsers();
</script>

</body>
</html>







