<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Chat App</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:Arial;
  display:flex;
  height:100vh;
}
.users{
  width:30%;
  border-left:1px solid #ccc;
  overflow:auto;
  padding:10px;
}
.chat-panel{
  flex:1;
  display:flex;
  flex-direction:column;
}
.messages{
  flex:1;
  overflow:auto;
  padding:10px;
  background:#f5f5f5;
}
.my{
  text-align:right;
  margin:6px;
}
.other{
  text-align:left;
  margin:6px;
}
.input-area{
  display:flex;
  padding:10px;
  border-top:1px solid #ccc;
  gap:6px;
}
img{
  max-width:220px;
  border-radius:10px;
  margin-top:5px;
}
button{
  cursor:pointer;
}
</style>
</head>

<body>

<div class="users">
  <h3>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</h3>
  <div id="users"></div>
</div>

<div class="chat-panel">
  <div class="messages" id="messages"></div>

  <div class="input-area">
    <input id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />
    <input type="file" id="imageInput" accept="image/*" style="display:none" />
    <button id="imgBtn">ðŸ“·</button>
    <button id="send">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<script>
/* =========================
   Ø¥Ø¹Ø¯Ø§Ø¯ Supabase
========================= */
const supabase = window.supabase.createClient(
  "https://szjeerdjuyuqyrixqihb.supabase.co",
  "sb_publishable_GpdhY2DBLlI0t3VdzXUWOA_dt43iBLx"
);

let me = null;
let chatId = null;

/* =========================
   Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¤Ù‚Øª
========================= */
async function initUser() {
  const username = "user_" + Math.floor(Math.random()*10000);

  const { data } = await supabase
    .from("users")
    .insert({ username })
    .select()
    .single();

  me = data;
  loadUsers();
}

/* =========================
   ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
========================= */
async function loadUsers() {

  const { data } = await supabase
    .from("users")
    .select("*");

  const list = document.getElementById("users");
  list.innerHTML = "";

  data.forEach(user=>{
    if(user.id === me.id) return;

    const div = document.createElement("div");
    div.textContent = user.username;
    div.style.cursor = "pointer";
    div.onclick = ()=> startChat(user.id);
    list.appendChild(div);
  });
}

/* =========================
   Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø©
========================= */
async function startChat(otherId){

  const { data: existing } = await supabase
    .from("chats")
    .select("*")
    .or(`and(user1.eq.${me.id},user2.eq.${otherId}),and(user1.eq.${otherId},user2.eq.${me.id})`)
    .maybeSingle();

  if(existing){
    chatId = existing.id;
  } else {
    const { data } = await supabase
      .from("chats")
      .insert({ user1:me.id , user2:otherId

