<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title> Ø­ÙˆÙ„Ù†Ø§</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin:0;
  padding:0;
  background:#f2f4f7;
  display:flex;
  flex-direction:column;
  height:100vh;
}

/* Ø§Ù„Ù‡ÙŠØ¯Ø± */
header {
  width:100%;
  background:#1a73e8;
  color:white;
  padding:15px;
  font-size:20px;
  text-align:center;
}

/* Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ */
#user-list {
  width:100%;
  background:white;
  padding:10px;
  display:flex;
  gap:10px;
  overflow-x:auto;
  border-bottom:1px solid #ddd;
}

#user-list h3 {
  margin:0 10px;
  display:flex;
  align-items:center;
}

#user-list button {
  padding:8px 15px;
  border:none;
  border-radius:20px;
  cursor:pointer;
  background:#e4e6eb;
  white-space:nowrap;
}

#user-list button:hover {
  background:#cfd3d8;
}

/* Ù„ÙˆØ­Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
.chat-panel {
  flex:1;
  display:flex;
  flex-direction:column;
  padding:15px;
}

/* Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
#chat-header {
  font-size:18px;
  margin-bottom:10px;
}

/* Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
#messages {
  flex:1;
  overflow-y:auto;
  background:white;
  border-radius:10px;
  padding:15px;
  display:flex;
  flex-direction:column;
  gap:5px;
  font-size:16px;
}

/* Ø´ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
.my {
  background:#0084ff;
  color:white;
  padding:8px 14px;
  border-radius:18px;
  align-self:flex-end;
  max-width:70%;
}

.other {
  background:#4caf50;
  color:white;
  padding:8px 14px;
  border-radius:18px;
  align-self:flex-start;
  max-width:70%;
}

/* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
.input-area {
  display:flex;
  padding:10px;
  background:white;
  border-top:1px solid #ddd;
}

#msg {
  flex:1;
  padding:12px;
  border-radius:25px;
  border:1px solid #ccc;
  font-size:15px;
}

#send {
  margin-left:10px;
  padding:10px 20px;
  border:none;
  border-radius:25px;
  background:#1a73e8;
  color:white;
  cursor:pointer;
}

#send:hover {
  background:#1557b0;
}
  /* Ø¥Ø´Ø¹Ø§Ø± Ù…Ø±Ø¦ÙŠ */
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #1a73e8;
  color: white;
  padding: 12px 18px;
  border-radius: 8px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  font-size: 14px;
  opacity: 0;
  transform: translateY(-20px);
  transition: all 0.3s ease;
  z-index: 9999;
}

.toast.show {
  opacity: 1;
  transform: translateY(0);
}
.unread-badge {
  color: red;
  font-weight: bold;
}

</style>
</head>

<body>

<header>Ø¯Ø±Ø¯Ø´Ø© Ø­ÙˆÙ„Ù†Ø§</header>

<!-- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ -->
<div id="user-list"></div>

<!-- Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¨Ø§Ù„Ø£Ø³ÙÙ„ Ø£ÙƒØ¨Ø± -->
<div class="chat-panel">
  <h3 id="chat-header">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h3>
  <div id="messages"></div>
  <div class="input-area">
    <input id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />
    <input type="file" id="imageInput" accept="image/*" style="display:none" />
<button id="imgBtn">ğŸ“·</button>

    <button id="send">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<script type="module">

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://szjeerdjuyuqyrixqihb.supabase.co",
  "sb_publishable_GpdhY2DBLlI0t3VdzXUWOA_dt43iBLx"
);

let me = null;
let chatId = null;
let channel = null;

/* =========================
   ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
========================= */
async function initUser() {
  let saved = localStorage.getItem("uid");

  if (saved) {
    let { data } = await supabase.from("users").select("*").eq("id", saved).single();
    if (data) { me = data; return; }
  }

  let name = prompt("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ");
  if (!name) return;

  let { data } = await supabase
    .from("users")
    .insert({ username: name })
    .select()
    .single();

  localStorage.setItem("uid", data.id);
  me = data;
}

/* =========================
   ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
========================= */
async function loadUsers() {

  let { data: users } = await supabase
    .from("users")
    .select("*")
    .neq("id", me.id);

  let box = document.getElementById("user-list");
  box.innerHTML = "";

  for (let u of users) {

    const { count } = await supabase
      .from("messages")
      .select("*", { count: "exact", head: true })
      .eq("sender_id", u.id)
      .eq("receiver_id", me.id)
      .eq("is_read", false);

    let b = document.createElement("button");

    if (count > 0) {
      b.innerHTML = `${u.username} <span style="color:red">(${count})</span>`;
    } else {
      b.textContent = u.username;
    }

    b.onclick = () => openChat(u);

    box.appendChild(b);
  }
}

/* =========================
   ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø©
========================= */
async function openChat(u) {

  let { data } = await supabase
    .from("chats")
    .select("*")
    .or(`and(user1.eq.${me.id},user2.eq.${u.id}),and(user1.eq.${u.id},user2.eq.${me.id})`)
    .single();

  if (!data) {
    let res = await supabase
      .from("chats")
      .insert({ user1: me.id, user2: u.id })
      .select()
      .single();

    data = res.data;
  }

  chatId = data.id;

  document.getElementById("chat-header").textContent = "Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ " + u.username;

  await loadMessages();

  await supabase
    .from("messages")
    .update({ is_read: true })
    .eq("chat_id", chatId)
    .eq("receiver_id", me.id);

  loadUsers();
}

/* =========================
   ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
========================= */
async function loadMessages() {

  let { data, error } = await supabase
    .from("messages")
    .select("*")
    .eq("chat_id", chatId)
    .order("created_at", { ascending: true });

  if (error) {
    console.error(error);
    return;
  }

  let box = document.getElementById("messages");
  box.innerHTML = "";

  data.forEach(msg => {

    let div = document.createElement("div");
    div.id = "msg-" + msg.id;
    div.className = msg.sender_id === me.id ? "my" : "other";

    // =========================
    // Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ
    // =========================
    if (msg.text) {
      let textNode = document.createElement("div");
      textNode.textContent = msg.text;
      div.appendChild(textNode);
    }

    // =========================
    // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©
    // =========================
    if (msg.image_url) {
      let img = document.createElement("img");
      img.src = msg.image_url;
      img.style.maxWidth = "220px";
      img.style.borderRadius = "10px";
      img.style.marginTop = "5px";
      div.appendChild(img);
    }

    // =========================
    // Ø²Ø± Ø§Ù„Ø­Ø°Ù Ù„Ù„Ø·Ø±ÙÙŠÙ†
    // =========================
    let delBtn = document.createElement("button");
    delBtn.textContent = "ğŸ—‘";
    delBtn.style.marginRight = "8px";
    delBtn.style.border = "none";
    delBtn.style.background = "transparent";
    delBtn.style.cursor = "pointer";

    delBtn.onclick = async () => {

      // Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† storage
      if (msg.image_url) {

        const path =
          msg.image_url.split("/chat-images/")[1];

        await supabase.storage
          .from("chat-images")
          .remove([path]);
      }

      // Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
      await supabase
        .from("messages")
        .delete()
        .eq("id", msg.id);
    };

    div.appendChild(delBtn);

    box.appendChild(div);
  });

  box.scrollTop = box.scrollHeight;
}

/* =========================
   Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„ÙÙˆØ±ÙŠ
========================= */
function listenMessages() {

  if (channel) supabase.removeChannel(channel);

  channel = supabase
    .channel("realtime-messages")

    .on(
      "postgres_changes",
      {
        event: "INSERT",
        schema: "public",
        table: "messages"
      },
      async (payload) => {

        const msg = payload.new;

        // Ù„Ø§ ØªØ¹Ø±Ø¶ Ø±Ø³Ø§Ù„ØªÙŠ (Ø£Ù†Ø§ Ø£Ø¹Ø±Ø¶Ù‡Ø§ Ù…Ø­Ù„ÙŠØ§Ù‹)
        if (msg.sender_id === me.id) return;

        // Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ÙŠØ³Øª ÙÙŠ Ø§Ù„Ø´Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­
        if (msg.chat_id !== chatId) {
          loadUsers();
          return;
        }

        // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
        if (document.getElementById("msg-" + msg.id)) return;

        // Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„
        const { data: user } = await supabase
          .from("users")
          .select("username")
          .eq("id", msg.sender_id)
          .single();

        let box = document.getElementById("messages");

        let div = document.createElement("div");
        div.id = "msg-" + msg.id;
        div.className = "other";
        div.textContent = user.username + ": " + msg.text;

        box.appendChild(div);
        box.scrollTop = box.scrollHeight;

        // ØªØ­Ø¯ÙŠØ«Ù‡Ø§ ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©
        await supabase
          .from("messages")
          .update({ is_read: true })
          .eq("id", msg.id);

        loadUsers();
      }
    )

    .on(
      "postgres_changes",
      {
        event: "DELETE",
        schema: "public",
        table: "messages"
      },
      (payload) => {
        let el = document.getElementById("msg-" + payload.old.id);
        if (el) el.remove();
      }
    )

    .subscribe();
}


/* =========================
   Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
========================= */
async function sendMessage() {

  let input = document.getElementById("msg");
  let text = input.value.trim();

  if (!text || !chatId) return;

  const { data: chat } = await supabase
    .from("chats")
    .select("user1, user2")
    .eq("id", chatId)
    .single();

  let receiverId = chat.user1 === me.id ? chat.user2 : chat.user1;

  const { data } = await supabase
    .from("messages")
    .insert({
      chat_id: chatId,
      sender_id: me.id,
      receiver_id: receiverId,
      text: text,
      is_read: false
    })
    .select()
    .single();

  input.value = "";

  await loadMessages();
}

/* =========================
   Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±
========================= */
document.getElementById("send").addEventListener("click", sendMessage);

document.getElementById("msg").addEventListener("keypress", e => {
  if (e.key === "Enter") sendMessage();
});

/* =========================
   ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
========================= */
await initUser();
await loadUsers();
listenMessages();
function setupSendButton() {

  const sendBtn = document.getElementById("send");
  const msgInput = document.getElementById("msg");
  const imageInput = document.getElementById("imageInput");
  const imgBtn = document.getElementById("imgBtn");

  // ÙØªØ­ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±
  imgBtn.onclick = () => imageInput.click();

  async function sendMessage() {

    let text = msgInput.value.trim();
    let file = imageInput.files[0];

    if (!text && !file) return;

    if (!chatId) {
      alert("Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹");
      return;
    }

    try {

      // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
      const { data: chat, error: chatError } = await supabase
        .from("chats")
        .select("user1, user2")
        .eq("id", chatId)
        .single();

      if (chatError) {
        console.error(chatError);
        return;
      }

      let receiverId =
        chat.user1 === me.id ? chat.user2 : chat.user1;

      let imageUrl = null;

      // =========================
      // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
      // =========================
      if (file) {

        const fileName =
          Date.now() + "-" + file.name;

        const { error: uploadError } =
          await supabase.storage
            .from("chat-images")
            .upload(fileName, file);

        if (uploadError) {
          console.error(uploadError);
          return;
        }

        const { data: publicUrl } =
          supabase.storage
            .from("chat-images")
            .getPublicUrl(fileName);

        imageUrl = publicUrl.publicUrl;
      }

      // =========================
      // Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
      // =========================
      const { data, error } = await supabase
        .from("messages")
        .insert({
          chat_id: chatId,
          sender_id: me.id,
          receiver_id: receiverId,
          text: text || null,
          image_url: imageUrl,
          is_read: false
        })
        .select()
        .single();

      if (error) {
        console.error(error);
        return;
      }

      // =========================
      // Ø¹Ø±Ø¶Ù‡Ø§ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙˆØ±Ø§Ù‹
      // =========================
      let box = document.getElementById("messages");

      let div = document.createElement("div");
      div.id = "msg-" + data.id;
      div.className = "my";

      if (data.text) {
        let textNode = document.createElement("div");
        textNode.textContent = data.text;
        div.appendChild(textNode);
      }

      if (data.image_url) {
        let img = document.createElement("img");
        img.src = data.image_url;
        img.style.maxWidth = "220px";
        img.style.borderRadius = "10px";
        img.style.marginTop = "5px";
        div.appendChild(img);
      }

      box.appendChild(div);
      box.scrollTop = box.scrollHeight;

      msgInput.value = "";
      imageInput.value = "";

    } catch (err) {
      console.error("Send Error:", err);
    }
  }

  sendBtn.onclick = sendMessage;

  msgInput.addEventListener("keypress", function (e) {
    if (e.key === "Enter") {
      sendMessage();
    }
  });
}



</script>
</body>
</html>








