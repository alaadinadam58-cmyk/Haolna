<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø­ÙˆÙ„Ù†Ø§</title>

<style>
/* ====== Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ÙƒÙ…Ø§ Ù‡Ùˆ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± ====== */
body {
  font-family: Arial, sans-serif;
  margin:0;
  padding:0;
  background:#f2f4f7;
  display:flex;
  flex-direction:column;
  height:100vh;
}

header {
  width:100%;
  background:#1a73e8;
  color:white;
  padding:15px;
  font-size:20px;
  text-align:center;
}

#user-list {
  width:100%;
  background:white;
  padding:10px;
  display:flex;
  gap:10px;
  overflow-x:auto;
  border-bottom:1px solid #ddd;
}

#user-list button {
  padding:8px 15px;
  border:none;
  border-radius:20px;
  cursor:pointer;
  background:#e4e6eb;
}

#user-list button:hover {
  background:#cfd3d8;
}

.chat-panel {
  flex:1;
  display:flex;
  flex-direction:column;
  padding:15px;
}

#messages {
  flex:1;
  overflow-y:auto;
  background:white;
  border-radius:10px;
  padding:15px;
  display:flex;
  flex-direction:column;
  gap:5px;
}

.my {
  background:#0084ff;
  color:white;
  padding:8px 14px;
  border-radius:18px;
  align-self:flex-end;
  max-width:70%;
}

.other {
  background:#4caf50;
  color:white;
  padding:8px 14px;
  border-radius:18px;
  align-self:flex-start;
  max-width:70%;
}

.input-area {
  display:flex;
  padding:10px;
  background:white;
  border-top:1px solid #ddd;
  gap:6px;
}

#msg {
  flex:1;
  padding:12px;
  border-radius:25px;
  border:1px solid #ccc;
}

#send, #imgBtn {
  padding:10px 20px;
  border:none;
  border-radius:25px;
  background:#1a73e8;
  color:white;
  cursor:pointer;
}

#send:hover, #imgBtn:hover {
  background:#1557b0;
}

img{
  max-width:200px;
  border-radius:10px;
  margin-top:5px;
}
</style>
</head>

<body>

<header>Ø¯Ø±Ø¯Ø´Ø© Ø­ÙˆÙ„Ù†Ø§</header>

<div id="user-list"></div>

<<!-- Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¨Ø§Ù„Ø£Ø³ÙÙ„ Ø£ÙƒØ¨Ø± -->
<div class="chat-panel">
  <h3 id="chat-header">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h3>
  <div id="messages"></div>
  <div class="input-area">
  <input id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />

  <!-- input Ù…Ø®ÙÙŠ Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© -->
  <input type="file" id="imageInput" accept="image/*" style="display:none">

  <!-- Ø²Ø± Ø§Ù„ØµÙˆØ±Ø© -->
  <button id="imgBtn">ðŸ“·</button>

  <button id="send">Ø¥Ø±Ø³Ø§Ù„</button>
</div>

</div>

<script type="module">

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://szjeerdjuyuqyrixqihb.supabase.co",
  "sb_publishable_GpdhY2DBLlI0t3VdzXUWOA_dt43iBLx"
);

let me = null;
let chatId = null;
let channel = null;

/* =========================
   Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø©
========================= */
async function sendImage(file) {

  if (!file || !chatId) return;

  const { data: chat } = await supabase
    .from("chats")
    .select("user1, user2")
    .eq("id", chatId)
    .single();

  let receiverId =
    chat.user1 === me.id ? chat.user2 : chat.user1;

  const fileName = Date.now() + "-" + file.name;

  const { error } = await supabase.storage
    .from("chat-images")
    .upload(fileName, file);

  if (error) {
    alert("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©");
    return;
  }

  const { data: publicUrl } =
    supabase.storage
      .from("chat-images")
      .getPublicUrl(fileName);

  await supabase
    .from("messages")
    .insert({
      chat_id: chatId,
      sender_id: me.id,
      receiver_id: receiverId,
      image_url: publicUrl.publicUrl,
      is_read: false
    });

  await loadMessages();
}

/* =========================
   Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±
========================= */
document.getElementById("send").addEventListener("click", sendMessage);

document.getElementById("msg").addEventListener("keypress", e => {
  if (e.key === "Enter") sendMessage();
});

document.getElementById("imgBtn").onclick = () => {
  document.getElementById("imageInput").click();
};

document.getElementById("imageInput")
  .addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (file) {
      await sendImage(file);
      e.target.value = "";




