<!DOCTYPE html>
<html dir="rtl">
<head>
<meta charset="UTF-8">
<title>WhatsApp Style Chat</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:Arial;
  display:flex;
  height:100vh;
}

#users{
  width:30%;
  border-left:1px solid #ccc;
  padding:10px;
  overflow-y:auto;
  background:#f5f5f5;
}

#users button{
  width:100%;
  padding:10px;
  margin-bottom:5px;
  border:none;
  background:white;
  cursor:pointer;
  border-radius:8px;
}

#chat{
  width:70%;
  display:flex;
  flex-direction:column;
}

#header{
  padding:15px;
  background:#075e54;
  color:white;
  font-weight:bold;
}

#messages{
  flex:1;
  padding:10px;
  overflow-y:auto;
  background:#e5ddd5;
}

.msg{
  max-width:60%;
  padding:8px;
  margin:5px 0;
  border-radius:10px;
  clear:both;
  word-wrap:break-word;
}

.me{
  background:#dcf8c6;
  float:left;
}

.other{
  background:white;
  float:right;
}

.msg img{
  max-width:200px;
  display:block;
  margin-top:5px;
  border-radius:10px;
}

#inputArea{
  display:flex;
  padding:10px;
  background:white;
}

#inputArea input[type=text]{
  flex:1;
  padding:8px;
}

</style>
</head>
<body>

<div id="users"></div>

<div id="chat">
  <div id="header">اختر مستخدم</div>
  <div id="messages"></div>
  <div id="inputArea">
    <input type="text" id="textInput" placeholder="اكتب رسالة">
    <input type="file" id="imageInput">
    <button onclick="sendMessage()">إرسال</button>
  </div>
</div>

<script>
const supabase = window.supabase.createClient(
 "https://szjeerdjuyuqyrixqihb.supabase.co",
  "sb_publishable_GpdhY2DBLlI0t3VdzXUWOA_dt43iBLx"
);

let me = null;
let chatId = null;

/* ======================
   تسجيل المستخدم
====================== */
async function init(){
  let username = prompt("ادخل اسمك");
  if(!username) return;

  let { data } = await supabase
    .from("users")
    .select("*")
    .eq("username", username)
    .single();

  if(!data){
    let res = await supabase
      .from("users")
      .insert({ username })
      .select()
      .single();
    me = res.data;
  } else {
    me = data;
  }

  loadUsers();
}

async function loadUsers(){
  let { data } = await supabase
    .from("users")
    .select("*")
    .neq("id", me.id);

  let box = document.getElementById("users");
  box.innerHTML = "";

  data.forEach(u=>{
    let btn = document.createElement("button");
    btn.textContent = u.username;
    btn.onclick = ()=> openChat(u);
    box.appendChild(btn);
  });
}

async function openChat(u){
  document.getElementById("header").textContent = "الدردشة مع " + u.username;

  let { data } = await supabase
    .from("chats")
    .select("*")
    .or(`and(user1.eq.${me.id},user2.eq.${u.id}),and(user1.eq.${u.id},user2.eq.${me.id})`)
    .single();

  if(!data){
    let res = await supabase
      .from("chats")
      .insert({ user1: me.id, user2: u.id })
      .select()
      .single();
    data = res.data;
  }

  chatId = data.id;
  loadMessages();
}

async function loadMessages(){
  let { data } = await supabase
    .from("messages")
    .select("*")
    .eq("chat_id", chatId)
    .order("created_at");

  let box = document.getElementById("messages");
  box.innerHTML = "";

  data.forEach(msg=>{
    appendMessage(msg);
  });

  box.scrollTop = box.scrollHeight;
}

function appendMessage(msg){
  let div = document.createElement("div");
  div.className = "msg " + (msg.sender_id === me.id ? "me":"other");

  if(msg.text){
    div.innerText = msg.text;
  }

  if(msg.image_url){
    let img = document.createElement("img");
    img.src = msg.image_url;
    div.appendChild(img);
  }

  document.getElementById("messages").appendChild(div);
}

async function sendMessage(){
  if(!chatId) return;

  let text = document.getElementById("textInput").value;
  let file = document.getElementById("imageInput").files[0];

  let imageUrl = null;

  if(file){
    let fileName = Date.now()+"-"+file.name;

    await supabase.storage
      .from("chat-images")
      .upload(fileName, file);

    imageUrl = supabase.storage
      .from("chat-images")
      .getPublicUrl(fileName).data.publicUrl;
  }

  await supabase.from("messages").insert({
    chat_id: chatId,
    sender_id: me.id,
    text: text || null,
    image_url: imageUrl
  });

  document.getElementById("textInput").value="";
  document.getElementById("imageInput").value="";
}

supabase.channel("realtime")
.on("postgres_changes",
  { event:"INSERT", schema:"public", table:"messages" },
  payload=>{
    if(payload.new.chat_id === chatId){
      appendMessage(payload.new);
      document.getElementById("messages").scrollTop =
      document.getElementById("messages").scrollHeight;
    }
  }
)
.subscribe();

init();
</script>

</body>
</html>
